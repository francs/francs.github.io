<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">

<script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
</script>








<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/ruolin_bak.jpeg?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/ruolin_bak.jpeg?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Partition Table," />





  <link rel="alternate" href="/atom.xml" title="PostgreSQL 中文网" type="application/atom+xml" />






<meta name="description" content="PostgreSQL10 一个重量级新特性是支持分区表，在这之前，PostgreSQL不支持内置分区表，若要实现功能，需通过继承的方式实现，详见PostgreSQL: 分区表应用二(取模分区)。 PostgreSQL 内置分区表目前仅支持以下两种形式分区  范围分区（Range  Partitioning）  The table is partitioned into  “ranges”  def">
<meta name="keywords" content="Partition Table">
<meta property="og:type" content="article">
<meta property="og:title" content="PostgreSQL10：重量级新特性-支持分区表">
<meta property="og:url" content="https://postgres.fun/20170521123452.html">
<meta property="og:site_name" content="PostgreSQL 中文网">
<meta property="og:description" content="PostgreSQL10 一个重量级新特性是支持分区表，在这之前，PostgreSQL不支持内置分区表，若要实现功能，需通过继承的方式实现，详见PostgreSQL: 分区表应用二(取模分区)。 PostgreSQL 内置分区表目前仅支持以下两种形式分区  范围分区（Range  Partitioning）  The table is partitioned into  “ranges”  def">
<meta property="og:locale" content="zh-Hans">
<meta property="og:updated_time" content="2018-09-04T01:34:21.066Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="PostgreSQL10：重量级新特性-支持分区表">
<meta name="twitter:description" content="PostgreSQL10 一个重量级新特性是支持分区表，在这之前，PostgreSQL不支持内置分区表，若要实现功能，需通过继承的方式实现，详见PostgreSQL: 分区表应用二(取模分区)。 PostgreSQL 内置分区表目前仅支持以下两种形式分区  范围分区（Range  Partitioning）  The table is partitioned into  “ranges”  def">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '5.1.4',
    sidebar: {"position":"right","display":"always","offset":12,"b2t":false,"scrollpercent":true,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://postgres.fun/20170521123452.html"/>






  <title>PostgreSQL10：重量级新特性-支持分区表 | PostgreSQL 中文网</title>
  





  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?848171401a55ef3f26344ab9bfebea10";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




</head>

<p align="center" abcd </p>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-right page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">PostgreSQL 中文网</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">francs's blog</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-guestbook">
          <a href="/guestbook" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-comments"></i> <br />
            
            留言
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://postgres.fun/20170521123452.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="francs">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/francs.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="PostgreSQL 中文网">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">PostgreSQL10：重量级新特性-支持分区表</h1>
        

        <div class="post-meta">
	    
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-05-21T12:34:52+08:00">
                2017-05-21
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Postgres基础/" itemprop="url" rel="index">
                    <span itemprop="name">Postgres基础</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/20170521123452.html#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/20170521123452.html" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/20170521123452.html" class="leancloud_visitors" data-flag-title="PostgreSQL10：重量级新特性-支持分区表">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>PostgreSQL10 一个重量级新特性是支持分区表，在这之前，PostgreSQL不支持内置分区表，若要实现功能，需通过继承的方式实现，详见<a href="https://postgres.fun/20120529163722.html">PostgreSQL: 分区表应用二(取模分区)</a>。</p>
<p>PostgreSQL 内置分区表目前仅支持以下两种形式分区</p>
<ol>
<li><p>范围分区（Range  Partitioning）</p>
<blockquote>
<p>The table is partitioned into  “ranges”  defined  by a key column or  set of columns,  with  no overlap between the ranges of values assigned to different partitions.  For example, one might partition by date ranges,  or  by ranges of identifiers for particular business objects.</p>
</blockquote>
</li>
<li><p>列表分区（List  Partitioning）</p>
<blockquote>
<p>The table is partitioned by explicitly listing which key values appear in each partition.</p>
</blockquote>
</li>
</ol>
<h1 id="分区表语法"><a href="#分区表语法" class="headerlink" title="分区表语法"></a>分区表语法</h1><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> table_name (  ...  )</span><br><span class="line">[ <span class="keyword">PARTITION</span> <span class="keyword">BY</span> &#123; <span class="keyword">RANGE</span> | <span class="keyword">LIST</span> &#125;  (  &#123; column_name |  ( expression )  &#125;</span><br><span class="line"> <span class="keyword">CREATE</span> <span class="keyword">TABLE</span> table_name</span><br><span class="line"><span class="keyword">PARTITION</span> <span class="keyword">OF</span> parent_table [  (</span><br><span class="line">)  ] <span class="keyword">FOR</span> <span class="keyword">VALUES</span> partition_bound_spec</span><br></pre></td></tr></table></figure>
<h1 id="创建范围分区表"><a href="#创建范围分区表" class="headerlink" title="创建范围分区表"></a>创建范围分区表</h1><p>下面通过一个例子演示下：创建一个范围分区的分区表<br>创建父表<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> tmp_log (</span><br><span class="line"> <span class="keyword">id</span> <span class="built_in">serial</span>,</span><br><span class="line"> create_time <span class="keyword">timestamp</span>(<span class="number">0</span>) <span class="keyword">without</span> <span class="keyword">time</span> zone,</span><br><span class="line">remark <span class="built_in">char</span>(<span class="number">1</span>)</span><br><span class="line">) <span class="keyword">partition</span> <span class="keyword">by</span> <span class="keyword">RANGE</span>(create_time);</span><br><span class="line">  </span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> tmp_log_p2016_befor <span class="keyword">PARTITION</span> <span class="keyword">OF</span> tmp_log <span class="keyword">FOR</span> <span class="keyword">VALUES</span> <span class="keyword">FROM</span> (<span class="keyword">UNBOUNDED</span>) <span class="keyword">TO</span> (<span class="string">'2016-01-01'</span>);</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> tmp_log_p201601 <span class="keyword">PARTITION</span> <span class="keyword">OF</span> tmp_log <span class="keyword">FOR</span> <span class="keyword">VALUES</span> <span class="keyword">FROM</span> (<span class="string">'2016-01-01'</span>) <span class="keyword">TO</span> (<span class="string">'2016-02-01'</span>);</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> tmp_log_p201602 <span class="keyword">PARTITION</span> <span class="keyword">OF</span> tmp_log <span class="keyword">FOR</span> <span class="keyword">VALUES</span> <span class="keyword">FROM</span> (<span class="string">'2016-02-01'</span>) <span class="keyword">TO</span> (<span class="string">'2016-03-01'</span>);</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> tmp_log_p201603 <span class="keyword">PARTITION</span> <span class="keyword">OF</span> tmp_log <span class="keyword">FOR</span> <span class="keyword">VALUES</span> <span class="keyword">FROM</span> (<span class="string">'2016-03-01'</span>) <span class="keyword">TO</span> (<span class="string">'2016-04-01'</span>);</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> tmp_log_p201604 <span class="keyword">PARTITION</span> <span class="keyword">OF</span> tmp_log <span class="keyword">FOR</span> <span class="keyword">VALUES</span> <span class="keyword">FROM</span> (<span class="string">'2016-04-01'</span>) <span class="keyword">TO</span> (<span class="string">'2016-05-01'</span>);</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> tmp_log_p201605 <span class="keyword">PARTITION</span> <span class="keyword">OF</span> tmp_log <span class="keyword">FOR</span> <span class="keyword">VALUES</span> <span class="keyword">FROM</span> (<span class="string">'2016-05-01'</span>) <span class="keyword">TO</span> (<span class="string">'2016-06-01'</span>);</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> tmp_log_p201606 <span class="keyword">PARTITION</span> <span class="keyword">OF</span> tmp_log <span class="keyword">FOR</span> <span class="keyword">VALUES</span> <span class="keyword">FROM</span> (<span class="string">'2016-06-01'</span>) <span class="keyword">TO</span> (<span class="string">'2016-07-01'</span>);</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> tmp_log_p201607 <span class="keyword">PARTITION</span> <span class="keyword">OF</span> tmp_log <span class="keyword">FOR</span> <span class="keyword">VALUES</span> <span class="keyword">FROM</span> (<span class="string">'2016-07-01'</span>) <span class="keyword">TO</span> (<span class="string">'2016-08-01'</span>);</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> tmp_log_p201608 <span class="keyword">PARTITION</span> <span class="keyword">OF</span> tmp_log <span class="keyword">FOR</span> <span class="keyword">VALUES</span> <span class="keyword">FROM</span> (<span class="string">'2016-08-01'</span>) <span class="keyword">TO</span> (<span class="string">'2016-09-01'</span>);</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> tmp_log_p201609 <span class="keyword">PARTITION</span> <span class="keyword">OF</span> tmp_log <span class="keyword">FOR</span> <span class="keyword">VALUES</span> <span class="keyword">FROM</span> (<span class="string">'2016-09-01'</span>) <span class="keyword">TO</span> (<span class="string">'2016-10-01'</span>);</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> tmp_log_p201610 <span class="keyword">PARTITION</span> <span class="keyword">OF</span> tmp_log <span class="keyword">FOR</span> <span class="keyword">VALUES</span> <span class="keyword">FROM</span> (<span class="string">'2016-10-01'</span>) <span class="keyword">TO</span> (<span class="string">'2016-11-01'</span>);</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> tmp_log_p201611 <span class="keyword">PARTITION</span> <span class="keyword">OF</span> tmp_log <span class="keyword">FOR</span> <span class="keyword">VALUES</span> <span class="keyword">FROM</span> (<span class="string">'2016-11-01'</span>) <span class="keyword">TO</span> (<span class="string">'2016-12-01'</span>);</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> tmp_log_p201612 <span class="keyword">PARTITION</span> <span class="keyword">OF</span> tmp_log <span class="keyword">FOR</span> <span class="keyword">VALUES</span> <span class="keyword">FROM</span> (<span class="string">'2016-12-01'</span>) <span class="keyword">TO</span> (<span class="string">'2017-01-01'</span>);</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> tmp_log_p201701 <span class="keyword">PARTITION</span> <span class="keyword">OF</span> tmp_log <span class="keyword">FOR</span> <span class="keyword">VALUES</span> <span class="keyword">FROM</span> (<span class="string">'2017-01-01'</span>) <span class="keyword">TO</span> (<span class="string">'2017-02-01'</span>);</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> tmp_log_p201702 <span class="keyword">PARTITION</span> <span class="keyword">OF</span> tmp_log <span class="keyword">FOR</span> <span class="keyword">VALUES</span> <span class="keyword">FROM</span> (<span class="string">'2017-02-01'</span>) <span class="keyword">TO</span> (<span class="string">'2017-03-01'</span>);</span><br></pre></td></tr></table></figure></p>
<p>创建索引<br><figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">index</span> idx_tmp_log_p2016_befor_ctime <span class="keyword">on</span> tmp_log_p2016_befor <span class="keyword">using</span> btree (create_time);</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">index</span> idx_tmp_log_p201601_ctime <span class="keyword">on</span> tmp_log_p201601 <span class="keyword">using</span> btree (create_time);</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">index</span> idx_tmp_log_p201602_ctime <span class="keyword">on</span> tmp_log_p201602 <span class="keyword">using</span> btree (create_time);</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">index</span> idx_tmp_log_p201603_ctime <span class="keyword">on</span> tmp_log_p201603 <span class="keyword">using</span> btree (create_time);</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">index</span> idx_tmp_log_p201604_ctime <span class="keyword">on</span> tmp_log_p201604 <span class="keyword">using</span> btree (create_time);</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">index</span> idx_tmp_log_p201605_ctime <span class="keyword">on</span> tmp_log_p201605 <span class="keyword">using</span> btree (create_time);</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">index</span> idx_tmp_log_p201606_ctime <span class="keyword">on</span> tmp_log_p201606 <span class="keyword">using</span> btree (create_time);</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">index</span> idx_tmp_log_p201607_ctime <span class="keyword">on</span> tmp_log_p201607 <span class="keyword">using</span> btree (create_time);</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">index</span> idx_tmp_log_p201608_ctime <span class="keyword">on</span> tmp_log_p201608 <span class="keyword">using</span> btree (create_time);</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">index</span> idx_tmp_log_p201609_ctime <span class="keyword">on</span> tmp_log_p201609 <span class="keyword">using</span> btree (create_time);</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">index</span> idx_tmp_log_p201610_ctime <span class="keyword">on</span> tmp_log_p201610 <span class="keyword">using</span> btree (create_time);</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">index</span> idx_tmp_log_p201611_ctime <span class="keyword">on</span> tmp_log_p201611 <span class="keyword">using</span> btree (create_time);</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">index</span> idx_tmp_log_p201612_ctime <span class="keyword">on</span> tmp_log_p201612 <span class="keyword">using</span> btree (create_time);</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">index</span> idx_tmp_log_p201701_ctime <span class="keyword">on</span> tmp_log_p201701 <span class="keyword">using</span> btree (create_time);</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">index</span> idx_tmp_log_p201702_ctime <span class="keyword">on</span> tmp_log_p201702 <span class="keyword">using</span> btree (create_time);</span><br></pre></td></tr></table></figure></p>
<p>备注：主要通过以上三步完成分区表创建，注意 constraint_exclusion 设备成 partition ；目前分区上的索引、约束、主键需要使用单独的命令创建。</p>
<p>插入测试数据<br><figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">francs=&gt; insert <span class="keyword">into</span> tmp_log (create_time,remark)</span><br><span class="line"><span class="keyword">select</span> generate_series(<span class="string">'2015-11-01'</span><span class="type">::date</span>,  <span class="string">'2017-02-28'</span><span class="type">::date</span>,  <span class="string">'1 hour'</span>),<span class="string">'1'</span>;</span><br><span class="line">INSERT <span class="number">0</span>  <span class="number">11641</span></span><br></pre></td></tr></table></figure></p>
<p>备注：利用generate_series 函数生成时间戳测试数据，一天插入24条数据，测试样例数据如下。</p>
<p>数据插入溢出<br><figure class="highlight subunit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">francs=&gt; insert into tmp_log (create_time,remark)</span><br><span class="line">francs-&gt;  select generate_series('2015<span class="string">-11</span><span class="string">-01</span>'::date,  '2018<span class="string">-01</span><span class="string">-01</span>'::date,  '1 hour'),'1';</span><br><span class="line"><span class="keyword">ERROR: </span>no partition of relation "tmp_log" found for row</span><br><span class="line">DETAIL: Partition key of the failing row contains (create_time)  =  (2017<span class="string">-03</span><span class="string">-01</span>  00:00:00).</span><br></pre></td></tr></table></figure></p>
<p>备注：如果插入的数据没有对应的分区，报如上错误。</p>
<p>查看数据量<br><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">francs=&gt;  select  *  from tmp<span class="emphasis">_log limit 3;</span></span><br><span class="line"><span class="emphasis">id | create_</span>time | remark</span><br><span class="line">-------<span class="code">+---------------------+</span>--------</span><br><span class="line">24795  |  2016-01-01  00:00:00  |  1</span><br><span class="line">24796  |  2016-01-01  01:00:00  |  1</span><br><span class="line">24797  |  2016-01-01  02:00:00  |  1</span><br><span class="line">(3 rows)</span><br><span class="line"><span class="code">  </span></span><br><span class="line">francs=&gt;  select count(<span class="strong">*)  from tmp_log;</span></span><br><span class="line"><span class="strong">count</span></span><br><span class="line"><span class="strong">-------</span></span><br><span class="line"><span class="strong">11641</span></span><br><span class="line"><span class="strong">(1 row)</span></span><br><span class="line"><span class="strong">  </span></span><br><span class="line"><span class="strong">francs=&gt;  select count(*</span>)  from tmp<span class="emphasis">_log_</span>p201601;</span><br><span class="line">count</span><br><span class="line">-------</span><br><span class="line">744</span><br><span class="line">(1 row)</span><br><span class="line"><span class="code">  </span></span><br><span class="line">francs=&gt;  select count(<span class="strong">*)  from tmp_log_p201602;</span></span><br><span class="line"><span class="strong">count</span></span><br><span class="line"><span class="strong">-------</span></span><br><span class="line"><span class="strong">696</span></span><br><span class="line"><span class="strong">(1 row)</span></span><br><span class="line"><span class="strong">  </span></span><br><span class="line"><span class="strong">francs=&gt;  select count(*</span>)  from tmp<span class="emphasis">_log_</span>p201609;</span><br><span class="line">count</span><br><span class="line">-------</span><br><span class="line">720</span><br><span class="line">(1 row)</span><br></pre></td></tr></table></figure></p>
<h1 id="查看执行计划"><a href="#查看执行计划" class="headerlink" title="查看执行计划"></a>查看执行计划</h1><figure class="highlight gauss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">francs=&gt; explain analyze <span class="built_in">select</span>  *  from tmp_log <span class="built_in">where</span> create_time &gt;  '<span class="number">2016</span><span class="number">-01</span><span class="number">-01</span>'  <span class="keyword">and</span> create_time &lt;  '<span class="number">2016</span><span class="number">-01</span><span class="number">-02</span>';</span><br><span class="line">                                     QUERY PLAN                   </span><br><span class="line">-----------------------------------------------------------------------------------------------------------------</span><br><span class="line">Append (cost=<span class="number">0.15</span>.<span class="number">.4</span><span class="number">.63</span> <span class="built_in">rows</span>=<span class="number">24</span> width=<span class="number">14</span>)  (actual <span class="built_in">time</span>=<span class="number">0.009</span>.<span class="number">.0</span><span class="number">.015</span> <span class="built_in">rows</span>=<span class="number">23</span> loops=<span class="number">1</span>)</span><br><span class="line">-&gt; Index  Scan  using idx_tmp_log_p201601_ctime on tmp_log_p201601(cost=<span class="number">0.15</span>.<span class="number">.4</span><span class="number">.63</span> <span class="built_in">rows</span>=<span class="number">24</span> width=<span class="number">14</span>)  (actual <span class="built_in">time</span>=<span class="number">0.008</span>.<span class="number">.0</span><span class="number">.012</span> <span class="built_in">rows</span>=<span class="number">23</span> loops=<span class="number">1</span>)</span><br><span class="line">Index  <span class="built_in">Cond</span>:  ((create_time &gt;  '<span class="number">2016</span><span class="number">-01</span><span class="number">-01</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>'::timestamp without <span class="built_in">time</span> zone) <span class="keyword">AND</span> (create_time &lt;  '<span class="number">2016</span><span class="number">-01</span><span class="number">-02</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>'::timestamp without <span class="built_in">time</span> zone))</span><br><span class="line">Planning <span class="built_in">time</span>:  <span class="number">0.511</span> ms</span><br><span class="line">Execution <span class="built_in">time</span>:  <span class="number">0.037</span> ms</span><br><span class="line">(<span class="number">5</span> <span class="built_in">rows</span>)</span><br></pre></td></tr></table></figure>
<p>备注：从PLAN看出，索引扫描指定分区表 tmp_log_p201601。</p>
<h1 id="分区表管理"><a href="#分区表管理" class="headerlink" title="分区表管理"></a>分区表管理</h1><p>以下介绍常用的分区表管理操作：断开分区、连接分区、删除分区。</p>
<h2 id="断开分区"><a href="#断开分区" class="headerlink" title="断开分区"></a>断开分区</h2><figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">francs=&gt; alter <span class="keyword">table</span> tmp_log <span class="comment">DETACH PARTITION tmp_log_p201702</span>;</span><br><span class="line">ALTER <span class="keyword">TABLE</span></span><br></pre></td></tr></table></figure>
<p>备注：DETACH 操作是指将分区从分区表断开，类似从一列火车中断开一节车厢类似，这个表将转变成普通表，仍然可读写。</p>
<h2 id="连接分区"><a href="#连接分区" class="headerlink" title="连接分区"></a>连接分区</h2><figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">francs=&gt; alter <span class="keyword">table</span> tmp_log <span class="comment">ATTACH PARTITION tmp_log_p201702 FOR VALUES FROM (</span><span class="comment">'2017-02-01'</span><span class="comment">) TO (</span><span class="comment">'2017-03-01'</span><span class="comment">)</span>;</span><br><span class="line">ALTER <span class="keyword">TABLE</span></span><br></pre></td></tr></table></figure>
<p>备注：ATTACH 操作是指将普通表连接到指定分区表，有一点要注意，ATTACH 和 DETACH 操作过程中，会在父表、此张分区表上加上 AccessExclusiveLock 排它锁，因此分区表的这两个操作应该在业务低谷时进行，避免影响业务。</p>
<h2 id="删除分区"><a href="#删除分区" class="headerlink" title="删除分区"></a>删除分区</h2><figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">francs=&gt; drop <span class="keyword">table</span> tmp_log_p201702;</span><br><span class="line">DROP <span class="keyword">TABLE</span></span><br></pre></td></tr></table></figure>
<p>备注：删除对就分区表即可。</p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ul>
<li><a href="https://www.postgresql.org/docs/devel/static/ddl-partitioning.html" target="_blank" rel="noopener">Table Partitioning</a></li>
<li><a href="https://postgres.fun/20120529163722.html">PostgreSQL: 分区表应用二(取模分区) </a></li>
<li><a href="https://www.postgresql.org/docs/devel/static/sql-createtable.html" target="_blank" rel="noopener">CREATE TABLE</a></li>
</ul>

      
    </div>
    
    
    

    

    
      <div>
        <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">

<div>
<p style="text-align:left">最后推荐和张文升共同编写的《PostgreSQL实战》，本书基于PostgreSQL 10 编写，共18章，重点介绍SQL高级特性、并行查询、分区表、物理复制、逻辑复制、备份恢复、高可用、性能优化、PostGIS等，涵盖大量实战用例！</p>
<p style="text-align:left">购买链接：<a href="https://item.jd.com/12405774.html">https://item.jd.com/12405774.html</a></p>
<img src="/images/PostgreSQL实战_small.png" alt="PostgreSQL实战" style="margin: 0 auto;" />
</div>


<div>感谢支持！</div>
  <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
    <span>打赏</span>
  </button>
  <div id="QR" style="display: none;">

    
      <div id="wechat" style="display: inline-block">
        <img id="wechat_qr" src="/images/webchat.jpg" alt="francs 微信支付"/>
        <p>微信支付</p>
      </div>
    

    

    

  </div>
</div>

      </div>
    

    
      <div>
        <ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者：</strong>
    francs
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="https://postgres.fun/20170521123452.html" title="PostgreSQL10：重量级新特性-支持分区表">https://postgres.fun/20170521123452.html</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>
    本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-sa/4.0/" rel="external nofollow" target="_blank">CC BY-SA 4.0</a> 许可协议。转载请注明出处！
  </li>
</ul>

      </div>
    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Partition-Table/" rel="tag"># Partition Table</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/20170413090417.html" rel="next" title="《PostgreSQL High Performance Cookbook》英文版技术审校">
                <i class="fa fa-chevron-left"></i> 《PostgreSQL High Performance Cookbook》英文版技术审校
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/20170521162007.html" rel="prev" title="PostgreSQL10：Parallel Queries 增强">
                PostgreSQL10：Parallel Queries 增强 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  
    <div class="comments" id="comments">
    </div>
  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/francs.png"
                alt="francs" />
            
              <p class="site-author-name" itemprop="name">francs</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">553</span>
                  <span class="site-state-item-name">文章</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">21</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">56</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/francs" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://stackoverflow.com/users/527628/francs" target="_blank" title="StackOverflow">
                      
                        <i class="fa fa-fw fa-stack-overflow"></i>StackOverflow</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://weibo.com/u/1992989604" target="_blank" title="新浪微博">
                      
                        <i class="fa fa-fw fa-weibo"></i>新浪微博</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://www.linkedin.com/in/francs-tan-13903832/" target="_blank" title="Linkedin">
                      
                        <i class="fa fa-fw fa-linkedin"></i>Linkedin</a>
                  </span>
                
            </div>
          

          
          

          
     
     <div class="links-of-blogroll motion-element links-of-blogroll-block">
      <div class="links-of-blogroll-title">
        <!-- modify icon to fire by szw -->
        <i class="fa fa-history fa-" aria-hidden="true"></i>
        近期文章
      </div>
      <ul class="links-of-blogroll-list">
        
        
          <li>
            <a href="/20190116150800.html" title="Hexo: 给博客添加近期文章板块" target="_blank">Hexo: 给博客添加近期文章板块</a>
          </li>
        
          <li>
            <a href="/20190116103400.html" title="EnterpriseDB: 无人值守安装" target="_blank">EnterpriseDB: 无人值守安装</a>
          </li>
        
          <li>
            <a href="/20190115143600.html" title="EnterpriseDB: 交互式命令行安装" target="_blank">EnterpriseDB: 交互式命令行安装</a>
          </li>
        
          <li>
            <a href="/20190107095300.html" title="Hexo: 添加Valine评论(邮件通知、评论列表头像)" target="_blank">Hexo: 添加Valine评论(邮件通知、评论列表头像)</a>
          </li>
        
          <li>
            <a href="/20181219135100.html" title="PostgreSQL 2018 中国技术大会圆满举行" target="_blank">PostgreSQL 2018 中国技术大会圆满举行</a>
          </li>
        
      </ul>
    </div>
    
 
          
            <div class="links-of-blogroll motion-element links-of-blogroll-block">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                友情链接
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="http://www.postgres.cn" title="PostgreSQL中文社区" target="_blank">PostgreSQL中文社区</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://www.postgresql.org" title="PostgreSQL官网" target="_blank">PostgreSQL官网</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://dba.stackexchange.com" title="DBA.stackexchange" target="_blank">DBA.stackexchange</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://momjian.us/main/blogs/pgblog/2012.html" title="Bruce momjian's blog" target="_blank">Bruce momjian's blog</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://www.depesz.com" title="depesz's blog" target="_blank">depesz's blog</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://paquier.xyz" title="Michael Paquier's blog" target="_blank">Michael Paquier's blog</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://github.com/digoal/blog/blob/master/README.md" title="德哥博客" target="_blank">德哥博客</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://blog.osdba.net" title="Osdba's blog" target="_blank">Osdba's blog</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://my.oschina.net/Kenyon" title="Kenyon's blog" target="_blank">Kenyon's blog</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://www.brofive.org" title="钱五哥の自由空间" target="_blank">钱五哥の自由空间</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://lruihao.cn" title="博採眾長" target="_blank">博採眾長</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://dazuiba.skymobi.cn/" title="魂醉" target="_blank">魂醉</a>
                  </li>
                
              </ul>
            </div>
          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#分区表语法"><span class="nav-number">1.</span> <span class="nav-text">分区表语法</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#创建范围分区表"><span class="nav-number">2.</span> <span class="nav-text">创建范围分区表</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#查看执行计划"><span class="nav-number">3.</span> <span class="nav-text">查看执行计划</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#分区表管理"><span class="nav-number">4.</span> <span class="nav-text">分区表管理</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#断开分区"><span class="nav-number">4.1.</span> <span class="nav-text">断开分区</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#连接分区"><span class="nav-number">4.2.</span> <span class="nav-text">连接分区</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#删除分区"><span class="nav-number">4.3.</span> <span class="nav-text">删除分区</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#参考"><span class="nav-number">5.</span> <span class="nav-text">参考</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
</script>

<div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">francs</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>





  <span class="post-meta-divider">|</span>




  #<div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Gemini</a> v5.1.4</div>






        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info//busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv">
      <i class="fa fa-user"></i> 博客访客数
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
      人次
    </span>
  

  
    <span class="site-pv">
      <i class="fa fa-eye"></i> 博客访问量
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
      次
    </span>
  
</div>

<div >

<a target="_blank" href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=33010402003707" style="display:inline-block;text-decoration:none;height:20px;line-height:20px;"><img src="/images/gongan.png" style="float:left;"/>浙公网安备 33010402003707号</p></a><span class="post-meta-divider">|</span><span><a href="http://www.miitbeian.gov.cn">浙ICP备18045927号</a></span>

</div>








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
          <span id="scrollpercent"><span>0</span>%</span>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  










  <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
  <script src="//unpkg.com/valine/dist/Valine.min.js"></script>
  
  <script type="text/javascript">
    var GUEST = ['nick','mail','link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item=>{
      return GUEST.indexOf(item)>-1;
    });
    new Valine({
        el: '#comments' ,
        verify: false,
        notify: true,
        appId: 'UK8DCa4kSCj0Th48U4nGPxrO-gzGzoHsz',
        appKey: 'gxPalmYtqejoIqRUifA1Lqg6',
        placeholder: '留言',
        avatar:'',
        guest_info:guest,
        pageSize:'10' || 10,
        avatar_cdn:'https://www.gravatar.com/avatar/',
});
  </script>



  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'manual') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script>
  <script>AV.initialize("UK8DCa4kSCj0Th48U4nGPxrO-gzGzoHsz", "gxPalmYtqejoIqRUifA1Lqg6");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  

  
  

  

  

  

</body>
</html>
