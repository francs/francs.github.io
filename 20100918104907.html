<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">

<script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
</script>








<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/ruolin_bak.jpeg?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/ruolin_bak.jpeg?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="备份恢复," />





  <link rel="alternate" href="/atom.xml" title="PostgreSQL 中文网" type="application/atom+xml" />






<meta name="description" content="今天在将pg_dump压缩过的dump文件，通过pg_restore 导入到测试库时，中途异常中断，造成测试库宕机，而且之后数据无法启动。 数据库宕机的 Csvlog123456782010-09-17 17:28:03.943 CST,&quot;mydb&quot;,&quot;mydb&quot;,23936,&quot;192.168.1.25:58855&quot;,4c9334a3.5d80,1,&quot;/opt/pgsql/bin/postgres">
<meta name="keywords" content="备份恢复">
<meta property="og:type" content="article">
<meta property="og:title" content="PostgreSQL 恢复一例">
<meta property="og:url" content="https://postgres.fun/20100918104907.html">
<meta property="og:site_name" content="PostgreSQL 中文网">
<meta property="og:description" content="今天在将pg_dump压缩过的dump文件，通过pg_restore 导入到测试库时，中途异常中断，造成测试库宕机，而且之后数据无法启动。 数据库宕机的 Csvlog123456782010-09-17 17:28:03.943 CST,&quot;mydb&quot;,&quot;mydb&quot;,23936,&quot;192.168.1.25:58855&quot;,4c9334a3.5d80,1,&quot;/opt/pgsql/bin/postgres">
<meta property="og:locale" content="zh-Hans">
<meta property="og:updated_time" content="2018-09-04T01:33:46.144Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="PostgreSQL 恢复一例">
<meta name="twitter:description" content="今天在将pg_dump压缩过的dump文件，通过pg_restore 导入到测试库时，中途异常中断，造成测试库宕机，而且之后数据无法启动。 数据库宕机的 Csvlog123456782010-09-17 17:28:03.943 CST,&quot;mydb&quot;,&quot;mydb&quot;,23936,&quot;192.168.1.25:58855&quot;,4c9334a3.5d80,1,&quot;/opt/pgsql/bin/postgres">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '5.1.4',
    sidebar: {"position":"right","display":"always","offset":12,"b2t":false,"scrollpercent":true,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://postgres.fun/20100918104907.html"/>






  <title>PostgreSQL 恢复一例 | PostgreSQL 中文网</title>
  





  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?848171401a55ef3f26344ab9bfebea10";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




</head>

<p align="center" abcd </p>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-right page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">PostgreSQL 中文网</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">francs's blog</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-guestbook">
          <a href="/guestbook" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-comments"></i> <br />
            
            留言
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://postgres.fun/20100918104907.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="francs">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/francs.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="PostgreSQL 中文网">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">PostgreSQL 恢复一例</h1>
        

        <div class="post-meta">
	    
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2010-09-18T10:49:07+08:00">
                2010-09-18
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/PG案例分析/" itemprop="url" rel="index">
                    <span itemprop="name">PG案例分析</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/20100918104907.html#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/20100918104907.html" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/20100918104907.html" class="leancloud_visitors" data-flag-title="PostgreSQL 恢复一例">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>今天在将pg_dump压缩过的dump文件，通过pg_restore 导入到测试库时，中途异常中断，造成测试库宕机，而且之后数据无法启动。</p>
<h1 id="数据库宕机的-Csvlog"><a href="#数据库宕机的-Csvlog" class="headerlink" title="数据库宕机的 Csvlog"></a>数据库宕机的 Csvlog</h1><figure class="highlight autohotkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2010</span>-<span class="number">09</span>-<span class="number">17</span> <span class="number">17</span>:<span class="number">28</span>:<span class="number">03.943</span> CST,<span class="string">"mydb"</span>,<span class="string">"mydb"</span>,<span class="number">23936</span>,<span class="string">"192.168.1.25:58855"</span>,<span class="number">4</span>c9334a3.<span class="number">5</span>d80,<span class="number">1</span>,<span class="string">"/opt/pgsql/bin/postgres"</span>,<span class="number">2010</span>-<span class="number">09</span>-<span class="number">17</span> <span class="number">17</span>:<span class="number">28</span>:<span class="number">03</span> CST,,<span class="number">0</span>,FATAL,<span class="number">57</span>P03,<span class="string">"the database system is in recovery mode"</span>,,,,,,,,  </span><br><span class="line"><span class="number">2010</span>-<span class="number">09</span>-<span class="number">17</span> <span class="number">17</span>:<span class="number">28</span>:<span class="number">03.944</span> CST,<span class="string">"mydb"</span>,<span class="string">"mydb"</span>,<span class="number">23937</span>,<span class="string">"192.168.1.25:58856"</span>,<span class="number">4</span>c9334a3.<span class="number">5</span>d81,<span class="number">1</span>,<span class="string">"/opt/pgsql/bin/postgres"</span>,<span class="number">2010</span>-<span class="number">09</span>-<span class="number">17</span> <span class="number">17</span>:<span class="number">28</span>:<span class="number">03</span> CST,,<span class="number">0</span>,FATAL,<span class="number">57</span>P03,<span class="string">"the database system is in recovery mode"</span>,,,,,,,,  </span><br><span class="line"><span class="number">2010</span>-<span class="number">09</span>-<span class="number">17</span> <span class="number">17</span>:<span class="number">28</span>:<span class="number">03.954</span> CST,<span class="string">"mydb"</span>,<span class="string">"mydb"</span>,<span class="number">23938</span>,<span class="string">"192.168.1.25:58857"</span>,<span class="number">4</span>c9334a3.<span class="number">5</span>d82,<span class="number">1</span>,<span class="string">"/opt/pgsql/bin/postgres"</span>,<span class="number">2010</span>-<span class="number">09</span>-<span class="number">17</span> <span class="number">17</span>:<span class="number">28</span>:<span class="number">03</span> CST,,<span class="number">0</span>,FATAL,<span class="number">57</span>P03,<span class="string">"the database system is in recovery mode"</span>,,,,,,,,  </span><br><span class="line"><span class="number">2010</span>-<span class="number">09</span>-<span class="number">17</span> <span class="number">17</span>:<span class="number">28</span>:<span class="number">03.955</span> CST,<span class="string">"mydb"</span>,<span class="string">"mydb"</span>,<span class="number">23939</span>,<span class="string">"192.168.1.25:58858"</span>,<span class="number">4</span>c9334a3.<span class="number">5</span>d83,<span class="number">1</span>,<span class="string">"/opt/pgsql/bin/postgres"</span>,<span class="number">2010</span>-<span class="number">09</span>-<span class="number">17</span> <span class="number">17</span>:<span class="number">28</span>:<span class="number">03</span> CST,,<span class="number">0</span>,FATAL,<span class="number">57</span>P03,<span class="string">"the database system is in recovery mode"</span>,,,,,,,,  </span><br><span class="line"><span class="number">2010</span>-<span class="number">09</span>-<span class="number">17</span> <span class="number">17</span>:<span class="number">28</span>:<span class="number">03.956</span> CST,<span class="string">"mydb"</span>,<span class="string">"mydb"</span>,<span class="number">23940</span>,<span class="string">"192.168.1.25:58859"</span>,<span class="number">4</span>c9334a3.<span class="number">5</span>d84,<span class="number">1</span>,<span class="string">"/opt/pgsql/bin/postgres"</span>,<span class="number">2010</span>-<span class="number">09</span>-<span class="number">17</span> <span class="number">17</span>:<span class="number">28</span>:<span class="number">03</span> CST,,<span class="number">0</span>,FATAL,<span class="number">57</span>P03,<span class="string">"the database system is in recovery mode"</span>,,,,,,,,  </span><br><span class="line"><span class="number">2010</span>-<span class="number">09</span>-<span class="number">17</span> <span class="number">17</span>:<span class="number">28</span>:<span class="number">04.032</span> CST,,,<span class="number">32240</span>,,<span class="number">4</span>c932f7d.<span class="number">7</span>df0,<span class="number">9</span>,,<span class="number">2010</span>-<span class="number">09</span>-<span class="number">17</span> <span class="number">17</span>:<span class="number">06</span>:<span class="number">05</span> CST,,<span class="number">0</span>,FATAL,<span class="number">53100</span>,<span class="string">"could not write to file "</span><span class="string">"pg_xlog/xlogtemp.32240"</span><span class="string">": No space left on device"</span>,,,,,,,,  </span><br><span class="line"><span class="number">2010</span>-<span class="number">09</span>-<span class="number">17</span> <span class="number">17</span>:<span class="number">28</span>:<span class="number">04.098</span> CST,,,<span class="number">946</span>,,<span class="number">4</span>c9321d4.<span class="number">3</span>b2,<span class="number">5</span>,,<span class="number">2010</span>-<span class="number">09</span>-<span class="number">17</span> <span class="number">16</span>:<span class="number">07</span>:<span class="number">48</span> CST,,<span class="number">0</span>,LOG,<span class="number">00000</span>,<span class="string">"startup process (PID 32240) exited with exit code 1"</span>,,,,,,,,  </span><br><span class="line"><span class="number">2010</span>-<span class="number">09</span>-<span class="number">17</span> <span class="number">17</span>:<span class="number">28</span>:<span class="number">04.098</span> CST,,,<span class="number">946</span>,,<span class="number">4</span>c9321d4.<span class="number">3</span>b2,<span class="number">6</span>,,<span class="number">2010</span>-<span class="number">09</span>-<span class="number">17</span> <span class="number">16</span>:<span class="number">07</span>:<span class="number">48</span> CST,,<span class="number">0</span>,LOG,<span class="number">00000</span>,<span class="string">"aborting startup due to startup process failure"</span>,,,,,,,,</span><br></pre></td></tr></table></figure>
<p>从数据库down机前的 csvlog日志来看，down机前数据库SERVER 处于 recovery mode , 说明pg_restore时 SERVER此时有异常，之后尝试重新起动Server,命令如下  </p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[postgres@PG1 bin]$ pg_ctl -D <span class="variable">$PGDATA</span> start  </span><br><span class="line">server starting</span><br></pre></td></tr></table></figure>
<p>虽然显示’server starting’, 但数据库并没有真正起来，因为这时数据库根本无法连接,接着查看 csvlog  </p>
<h1 id="数据库启动异常时-Csvlog"><a href="#数据库启动异常时-Csvlog" class="headerlink" title="数据库启动异常时 Csvlog"></a>数据库启动异常时 Csvlog</h1><figure class="highlight autohotkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2010</span>-<span class="number">09</span>-<span class="number">17</span> <span class="number">17</span>:<span class="number">36</span>:<span class="number">36.660</span> CST,<span class="string">"mydb"</span>,<span class="string">"mydb"</span>,<span class="number">24245</span>,<span class="string">"192.168.169.42:42566"</span>,<span class="number">4</span>c9336a4.<span class="number">5</span>eb5,<span class="number">1</span>,<span class="string">"/opt/pgsql/bin/postgres"</span>,<span class="number">2010</span>-<span class="number">09</span>-<span class="number">17</span> <span class="number">17</span>:<span class="number">36</span>:<span class="number">36</span> CST,,<span class="number">0</span>,FATAL,<span class="number">57</span>P03,<span class="string">"the database system is starting up"</span>,,,,,,,,  </span><br><span class="line"><span class="number">2010</span>-<span class="number">09</span>-<span class="number">17</span> <span class="number">17</span>:<span class="number">36</span>:<span class="number">36.662</span> CST,<span class="string">"mydb"</span>,<span class="string">"mydb"</span>,<span class="number">24247</span>,<span class="string">"192.168.169.42:42567"</span>,<span class="number">4</span>c9336a4.<span class="number">5</span>eb7,<span class="number">1</span>,<span class="string">"/opt/pgsql/bin/postgres"</span>,<span class="number">2010</span>-<span class="number">09</span>-<span class="number">17</span> <span class="number">17</span>:<span class="number">36</span>:<span class="number">36</span> CST,,<span class="number">0</span>,FATAL,<span class="number">57</span>P03,<span class="string">"the database system is starting up"</span>,,,,,,,,  </span><br><span class="line"><span class="number">2010</span>-<span class="number">09</span>-<span class="number">17</span> <span class="number">17</span>:<span class="number">36</span>:<span class="number">36.663</span> CST,<span class="string">"mydb"</span>,<span class="string">"mydb"</span>,<span class="number">24246</span>,<span class="string">"192.168.1.25:33223"</span>,<span class="number">4</span>c9336a4.<span class="number">5</span>eb6,<span class="number">1</span>,<span class="string">"/opt/pgsql/bin/postgres"</span>,<span class="number">2010</span>-<span class="number">09</span>-<span class="number">17</span> <span class="number">17</span>:<span class="number">36</span>:<span class="number">36</span> CST,,<span class="number">0</span>,FATAL,<span class="number">57</span>P03,<span class="string">"the database system is starting up"</span>,,,,,,,,  </span><br><span class="line"><span class="number">2010</span>-<span class="number">09</span>-<span class="number">17</span> <span class="number">17</span>:<span class="number">36</span>:<span class="number">36.663</span> CST,<span class="string">"mydb"</span>,<span class="string">"mydb"</span>,<span class="number">24248</span>,<span class="string">"192.168.169.42:42568"</span>,<span class="number">4</span>c9336a4.<span class="number">5</span>eb8,<span class="number">1</span>,<span class="string">"/opt/pgsql/bin/postgres"</span>,<span class="number">2010</span>-<span class="number">09</span>-<span class="number">17</span> <span class="number">17</span>:<span class="number">36</span>:<span class="number">36</span> CST,,<span class="number">0</span>,FATAL,<span class="number">57</span>P03,<span class="string">"the database system is starting up"</span>,,,,,,,,  </span><br><span class="line"><span class="number">2010</span>-<span class="number">09</span>-<span class="number">17</span> <span class="number">17</span>:<span class="number">36</span>:<span class="number">36.665</span> CST,<span class="string">"mydb"</span>,<span class="string">"mydb"</span>,<span class="number">24249</span>,<span class="string">"192.168.169.42:42569"</span>,<span class="number">4</span>c9336a4.<span class="number">5</span>eb9,<span class="number">1</span>,<span class="string">"/opt/pgsql/bin/postgres"</span>,<span class="number">2010</span>-<span class="number">09</span>-<span class="number">17</span> <span class="number">17</span>:<span class="number">36</span>:<span class="number">36</span> CST,,<span class="number">0</span>,FATAL,<span class="number">57</span>P03,<span class="string">"the database system is starting up"</span>,,,,,,,,  </span><br><span class="line"><span class="number">2010</span>-<span class="number">09</span>-<span class="number">17</span> <span class="number">17</span>:<span class="number">36</span>:<span class="number">36.666</span> CST,,,<span class="number">24163</span>,,<span class="number">4</span>c9336a3.<span class="number">5</span>e63,<span class="number">1</span>,,<span class="number">2010</span>-<span class="number">09</span>-<span class="number">17</span> <span class="number">17</span>:<span class="number">36</span>:<span class="number">35</span> CST,,<span class="number">0</span>,LOG,<span class="number">00000</span>,<span class="string">"startup process (PID 24165) exited with exit code 1"</span>,,,,,,,,  </span><br><span class="line"><span class="number">2010</span>-<span class="number">09</span>-<span class="number">17</span> <span class="number">17</span>:<span class="number">36</span>:<span class="number">36.666</span> CST,,,<span class="number">24163</span>,,<span class="number">4</span>c9336a3.<span class="number">5</span>e63,<span class="number">2</span>,,<span class="number">2010</span>-<span class="number">09</span>-<span class="number">17</span> <span class="number">17</span>:<span class="number">36</span>:<span class="number">35</span> CST,,<span class="number">0</span>,LOG,<span class="number">00000</span>,<span class="string">"aborting startup due to startup process failure"</span>,,,,,,,,</span><br></pre></td></tr></table></figure>
<p>从上面日志来看，可以看出Server 数据库正在启动（the database system is starting up”）, 但是到后面就异常中上了; 而且也没有多余的信息，由于事情紧迫，随即向师傅请教，师傅说数据库需要恢复，可以恢复到具体的时间点。以下是解决过程。  </p>
<h1 id="解决过程"><a href="#解决过程" class="headerlink" title="解决过程"></a>解决过程</h1><p>pg_controldata 查看PG SERVER 详细信息<br><figure class="highlight ldif"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">[postgres@PG1 bin]$ pg_controldata $PGDATA  </span><br><span class="line"><span class="attribute">pg_control version number</span>: 843  </span><br><span class="line"><span class="attribute">Catalog version number</span>: 200904091  </span><br><span class="line"><span class="attribute">Database system identifier</span>: 5509641090052341117  </span><br><span class="line"><span class="attribute">Database cluster state</span>: shut down  </span><br><span class="line"><span class="attribute">pg_control last modified</span>: Fri 17 Sep 2010 05:28:03 PM CST  </span><br><span class="line"><span class="attribute">Latest checkpoint location</span>: 137/BFFFF68  </span><br><span class="line"><span class="attribute">Prior checkpoint location</span>: 131/9D90C818  </span><br><span class="line"><span class="attribute">Latest checkpoint's REDO location</span>: 137/BFFFF68  </span><br><span class="line"><span class="attribute">Latest checkpoint's TimeLineID</span>: 1  </span><br><span class="line"><span class="attribute">Latest checkpoint's NextXID</span>: 0/64282  </span><br><span class="line"><span class="attribute">Latest checkpoint's NextOID</span>: 215491390  </span><br><span class="line"><span class="attribute">Latest checkpoint's NextMultiXactId</span>: 1  </span><br><span class="line"><span class="attribute">Latest checkpoint's NextMultiOffset</span>: 0  </span><br><span class="line"><span class="attribute">Time of latest checkpoint</span>: Fri 17 Sep 2010 05:26:05 PM CST  </span><br><span class="line"><span class="attribute">Minimum recovery ending location</span>: 0/0  </span><br><span class="line"><span class="attribute">Maximum data alignment</span>: 8  </span><br><span class="line"><span class="attribute">Database block size</span>: 8192  </span><br><span class="line"><span class="attribute">Blocks per segment of large relation</span>: 1048576  </span><br><span class="line"><span class="attribute">WAL block size</span>: 65536  </span><br><span class="line"><span class="attribute">Bytes per WAL segment</span>: 67108864  </span><br><span class="line"><span class="attribute">Maximum length of identifiers</span>: 64  </span><br><span class="line"><span class="attribute">Maximum columns in an index</span>: 32  </span><br><span class="line"><span class="attribute">Maximum size of a TOAST chunk</span>: 1996  </span><br><span class="line"><span class="attribute">Date/time type storage</span>: 64-bit integers  </span><br><span class="line"><span class="attribute">Float4 argument passing</span>: by value  </span><br><span class="line"><span class="attribute">Float8 argument passing</span>: by value</span><br></pre></td></tr></table></figure></p>
<p>重要的信息：<code>Latest checkpoint&#39;s NextXID: 0/64282, Latest checkpoint&#39;s NextXID</code> 是指最近一次安全的checkpoints的下一个事务ID，我们可以将数据库恢复到这一时刻。</p>
<p>通过pg_resetxlog 将数据库恢复到事务 64282 时刻<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[postgres@PG1 bin]$ pg_resetxlog <span class="comment">--help  </span></span><br><span class="line">pg_resetxlog resets the PostgreSQL transaction log.</span><br><span class="line">Usage:  </span><br><span class="line"> pg_resetxlog [OPTION]... DATADIR</span><br><span class="line">Options:  </span><br><span class="line"> -e XIDEPOCH <span class="keyword">set</span> <span class="keyword">next</span> <span class="keyword">transaction</span> <span class="keyword">ID</span> epoch  </span><br><span class="line"> -f <span class="keyword">force</span> <span class="keyword">update</span> <span class="keyword">to</span> be done  </span><br><span class="line"> -l TLI,<span class="keyword">FILE</span>,SEG <span class="keyword">force</span> <span class="keyword">minimum</span> WAL <span class="keyword">starting</span> location <span class="keyword">for</span> <span class="keyword">new</span> <span class="keyword">transaction</span> <span class="keyword">log</span>  </span><br><span class="line"> -m XID <span class="keyword">set</span> <span class="keyword">next</span> multitransaction <span class="keyword">ID</span>  </span><br><span class="line"> -n <span class="keyword">no</span> <span class="keyword">update</span>, just <span class="keyword">show</span> extracted control <span class="keyword">values</span> (<span class="keyword">for</span> testing)  </span><br><span class="line"> -o <span class="keyword">OID</span> <span class="keyword">set</span> <span class="keyword">next</span> <span class="keyword">OID</span>  </span><br><span class="line"> -O <span class="keyword">OFFSET</span> <span class="keyword">set</span> <span class="keyword">next</span> multitransaction <span class="keyword">offset</span>  </span><br><span class="line"> -x XID <span class="keyword">set</span> <span class="keyword">next</span> <span class="keyword">transaction</span> <span class="keyword">ID</span>  </span><br><span class="line"> <span class="comment">--help show this help, then exit  </span></span><br><span class="line"> <span class="comment">--version output version information, then exit</span></span><br><span class="line">Report bugs <span class="keyword">to</span> &lt;[pgsql-bugs@postgresql.org](mailto:pgsql-bugs@postgresql.org)&gt;.</span><br><span class="line">[postgres@PG1 <span class="keyword">bin</span>]$ pg_resetxlog -x <span class="number">64282</span> $PGDATA  </span><br><span class="line"><span class="keyword">Transaction</span> <span class="keyword">log</span> <span class="keyword">reset</span></span><br></pre></td></tr></table></figure></p>
<p>再次启动 PG SERVER，正常,此时数据库已恢复<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[postgres<span class="meta">@PG</span>1 bin]$ pg_ctl -D $PGDATA start  </span><br><span class="line">server starting  </span><br><span class="line">[postgres<span class="meta">@PG</span>1 bin]$ ps -ef | grep post  </span><br><span class="line">postgres <span class="number">25297</span> <span class="number">1</span> <span class="number">14</span> <span class="number">18</span>:<span class="number">08</span> pts<span class="regexp">/1 00:00:00 /</span>opt<span class="regexp">/pgsql/</span>bin<span class="regexp">/postgres -D /</span>opt<span class="regexp">/pgdata/</span>pg_root  </span><br><span class="line">postgres <span class="number">25298</span> <span class="number">25297</span> <span class="number">0</span> <span class="number">18</span>:<span class="number">08</span> ? 00:<span class="number">00</span>:<span class="number">00</span> <span class="string">postgres:</span> logger process  </span><br><span class="line">postgres <span class="number">25829</span> <span class="number">25297</span> <span class="number">0</span> <span class="number">18</span>:<span class="number">08</span> ? 00:<span class="number">00</span>:<span class="number">00</span> <span class="string">postgres:</span> writer process  </span><br><span class="line">postgres <span class="number">25830</span> <span class="number">25297</span> <span class="number">0</span> <span class="number">18</span>:<span class="number">08</span> ? 00:<span class="number">00</span>:<span class="number">00</span> <span class="string">postgres:</span> wal writer process  </span><br><span class="line">postgres <span class="number">25831</span> <span class="number">25297</span> <span class="number">0</span> <span class="number">18</span>:<span class="number">08</span> ? 00:<span class="number">00</span>:<span class="number">00</span> <span class="string">postgres:</span> stats collector process</span><br></pre></td></tr></table></figure></p>
<p>到了这里，数据库PG SERVER 终于可以启来了，这里顺便说一下，之前的 pg_restore 中途异常是因为脚本中加了 -j 参数，同时跑多个 pg_restore 线程， 造成 pg_restore 子线程连接丢失，pg_restore 脚本中去掉 -j 参数时，数据库顺利导入。</p>
<h1 id="Pg-controldata-官网文档介绍"><a href="#Pg-controldata-官网文档介绍" class="headerlink" title="Pg_controldata 官网文档介绍"></a>Pg_controldata 官网文档介绍</h1><blockquote>
<p>Name<br>pg_controldata ― display control information of a PostgreSQL database cluster<br>Synopsis<br>pg_controldata [datadir]<br>Description<br>pg_controldata prints information initialized during initdb, such as the catalog version. It also shows information about write-ahead logging and checkpoint processing. This information is cluster-wide, and not specific to any one database.<br>This utility can only be run by the user who initialized the cluster because it requires read access to the data directory. You can specify the data directory on the command line, or use the environment variable PGDATA.<br>Environment<br>PGDATA<br>Default data directory location</p>
</blockquote>
<h1 id="Pg-resetxlog-官网文档介绍"><a href="#Pg-resetxlog-官网文档介绍" class="headerlink" title="Pg_resetxlog 官网文档介绍"></a>Pg_resetxlog 官网文档介绍</h1><blockquote>
<p>pg_resetxlog ― reset the write-ahead log and other control information of a PostgreSQL database cluster</p>
</blockquote>

      
    </div>
    
    
    

    

    
      <div>
        <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">

<div>
<p style="text-align:left">最后推荐和张文升共同编写的《PostgreSQL实战》，本书基于PostgreSQL 10 编写，共18章，重点介绍SQL高级特性、并行查询、分区表、物理复制、逻辑复制、备份恢复、高可用、性能优化、PostGIS等，涵盖大量实战用例！</p>
<p style="text-align:left">购买链接：<a href="https://item.jd.com/12405774.html">https://item.jd.com/12405774.html</a></p>
<img src="/images/PostgreSQL实战_small.png" alt="PostgreSQL实战" style="margin: 0 auto;" />
</div>


<div>感谢支持！</div>
  <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
    <span>打赏</span>
  </button>
  <div id="QR" style="display: none;">

    
      <div id="wechat" style="display: inline-block">
        <img id="wechat_qr" src="/images/webchat.jpg" alt="francs 微信支付"/>
        <p>微信支付</p>
      </div>
    

    

    

  </div>
</div>

      </div>
    

    
      <div>
        <ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者：</strong>
    francs
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="https://postgres.fun/20100918104907.html" title="PostgreSQL 恢复一例">https://postgres.fun/20100918104907.html</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>
    本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-sa/4.0/" rel="external nofollow" target="_blank">CC BY-SA 4.0</a> 许可协议。转载请注明出处！
  </li>
</ul>

      </div>
    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/备份恢复/" rel="tag"># 备份恢复</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/20100908165944.html" rel="next" title="PostgreSQL Lock 一例">
                <i class="fa fa-chevron-left"></i> PostgreSQL Lock 一例
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/20100921154343.html" rel="prev" title="PostgreSQL 锁浅析">
                PostgreSQL 锁浅析 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  
    <div class="comments" id="comments">
    </div>
  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/francs.png"
                alt="francs" />
            
              <p class="site-author-name" itemprop="name">francs</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">551</span>
                  <span class="site-state-item-name">文章</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">21</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">56</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/francs" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://stackoverflow.com/users/527628/francs" target="_blank" title="StackOverflow">
                      
                        <i class="fa fa-fw fa-stack-overflow"></i>StackOverflow</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://weibo.com/u/1992989604" target="_blank" title="新浪微博">
                      
                        <i class="fa fa-fw fa-weibo"></i>新浪微博</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://www.linkedin.com/in/francs-tan-13903832/" target="_blank" title="Linkedin">
                      
                        <i class="fa fa-fw fa-linkedin"></i>Linkedin</a>
                  </span>
                
            </div>
          

          
          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-block">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                友情链接
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="http://www.postgres.cn" title="PostgreSQL中文社区" target="_blank">PostgreSQL中文社区</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://www.postgresql.org" title="PostgreSQL官网" target="_blank">PostgreSQL官网</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://dba.stackexchange.com" title="DBA.stackexchange" target="_blank">DBA.stackexchange</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://momjian.us/main/blogs/pgblog/2012.html" title="Bruce momjian's blog" target="_blank">Bruce momjian's blog</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://www.depesz.com" title="depesz's blog" target="_blank">depesz's blog</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://paquier.xyz" title="Michael Paquier's blog" target="_blank">Michael Paquier's blog</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://github.com/digoal/blog/blob/master/README.md" title="德哥博客" target="_blank">德哥博客</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://blog.osdba.net" title="Osdba's blog" target="_blank">Osdba's blog</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://my.oschina.net/Kenyon" title="Kenyon's blog" target="_blank">Kenyon's blog</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://www.brofive.org" title="钱五哥の自由空间" target="_blank">钱五哥の自由空间</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://lruihao.cn" title="博採眾長" target="_blank">博採眾長</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://dazuiba.skymobi.cn/" title="魂醉" target="_blank">魂醉</a>
                  </li>
                
              </ul>
            </div>
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#数据库宕机的-Csvlog"><span class="nav-number">1.</span> <span class="nav-text">数据库宕机的 Csvlog</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#数据库启动异常时-Csvlog"><span class="nav-number">2.</span> <span class="nav-text">数据库启动异常时 Csvlog</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#解决过程"><span class="nav-number">3.</span> <span class="nav-text">解决过程</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Pg-controldata-官网文档介绍"><span class="nav-number">4.</span> <span class="nav-text">Pg_controldata 官网文档介绍</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Pg-resetxlog-官网文档介绍"><span class="nav-number">5.</span> <span class="nav-text">Pg_resetxlog 官网文档介绍</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
</script>

<div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">francs</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>





  <span class="post-meta-divider">|</span>




  #<div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Gemini</a> v5.1.4</div>






        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info//busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv">
      <i class="fa fa-user"></i> 博客访客数
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
      人次
    </span>
  

  
    <span class="site-pv">
      <i class="fa fa-eye"></i> 博客访问量
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
      次
    </span>
  
</div>

<div >

<a target="_blank" href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=33010402003707" style="display:inline-block;text-decoration:none;height:20px;line-height:20px;"><img src="/images/gongan.png" style="float:left;"/>浙公网安备 33010402003707号</p></a><span class="post-meta-divider">|</span><span><a href="http://www.miitbeian.gov.cn">浙ICP备18045927号</a></span>

</div>








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
          <span id="scrollpercent"><span>0</span>%</span>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  










  <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
  <script src="//unpkg.com/valine/dist/Valine.min.js"></script>
  
  <script type="text/javascript">
    var GUEST = ['nick','mail','link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item=>{
      return GUEST.indexOf(item)>-1;
    });
    new Valine({
        el: '#comments' ,
        verify: false,
        notify: true,
        appId: 'UK8DCa4kSCj0Th48U4nGPxrO-gzGzoHsz',
        appKey: 'gxPalmYtqejoIqRUifA1Lqg6',
        placeholder: '留言',
        avatar:'',
        guest_info:guest,
        pageSize:'10' || 10,
        avatar_cdn:'https://www.gravatar.com/avatar/',
});
  </script>



  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'manual') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script>
  <script>AV.initialize("UK8DCa4kSCj0Th48U4nGPxrO-gzGzoHsz", "gxPalmYtqejoIqRUifA1Lqg6");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  

  
  

  

  

  

</body>
</html>
